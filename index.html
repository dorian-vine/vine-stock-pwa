<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Vine Stock (FNSKU ‚Üí ASIN)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f6f7fb;margin:0;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
h1{margin:0 0 8px 0}
button,select,input{font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #ccc}
button.primary{background:#111;color:#fff;border:none}
button.secondary{background:#eee;border:none}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.muted{color:#777;font-size:13px}
.product{display:flex;gap:12px;margin-top:14px}
.product img{width:72px;height:72px;object-fit:contain;border-radius:8px;background:#fafafa}
.badge{background:#eee;border-radius:8px;padding:4px 8px;font-size:12px}
.history{margin-top:6px;font-size:13px;color:#444}
</style>
</head>

<body>

<div class="card">
  <h1>üì¶ Vine Stock (FNSKU ‚Üí ASIN)</h1>
  <div class="muted">Scan via Binary Eye ‚Üí reviens ici ‚Üí le champ est auto-focus + auto-select.</div>
</div>

<div class="card">
  <h2>1Ô∏è‚É£ Scanner / coller le FNSKU</h2>

  <input id="fnskuInput" placeholder="FNSKU (ex: X000QEDMAD)" style="width:100%;margin-bottom:10px">

  <div class="row">
    <button class="primary" onclick="doSearch()">Chercher</button>
    <button class="secondary" onclick="clearResults()">Effacer</button>
    <button class="secondary" onclick="toggleSettings()">‚öôÔ∏è R√©glages</button>
  </div>

  <!-- FILTRE COMPTE -->
  <div class="row" style="margin-top:12px">
    <label class="muted">Filtre compte</label>
    <select id="accountFilter" onchange="doSearch()">
      <option value="">Tous les comptes</option>
    </select>
  </div>

  <div class="muted" id="statusMsg" style="margin-top:8px"></div>
</div>

<div class="card" id="results"></div>

<!-- ===================== JS ===================== -->

<script>
/* ================= UTIL ================= */

function $(id){return document.getElementById(id)}

function aliasFromEmail(email){
  if(!email) return '';
  return email.split('@')[0].replace(/[^a-zA-Z]/g,'').toLowerCase();
}

function formatJJMM(d){
  if(!d) return '';
  const x = new Date(d.replace(' ','T'));
  if(isNaN(x)) return '';
  return String(x.getDate()).padStart(2,'0') + '/' + String(x.getMonth()+1).padStart(2,'0');
}

function getLastOrderTimestamp(product){
  let max = 0;
  (product.history||[]).forEach(h=>{
    const t = Date.parse(String(h.order_date||'').replace(' ','T'));
    if(!isNaN(t) && t > max) max = t;
  });
  return max;
}

function extractAccounts(history){
  const set = new Set();
  (history||[]).forEach(h=>{
    if(h.email) set.add(aliasFromEmail(h.email));
  });
  return Array.from(set);
}

function lastOrderForAccount(product, account){
  let max = 0;
  (product.history||[]).forEach(h=>{
    if(aliasFromEmail(h.email) === account){
      const t = Date.parse(String(h.order_date||'').replace(' ','T'));
      if(!isNaN(t) && t > max) max = t;
    }
  });
  return max;
}

/* ================= DATA ================= */

let ALL_PRODUCTS = [];

/* ================= SEARCH ================= */

async function doSearch(){
  const q = $('fnskuInput').value.trim().toUpperCase();
  const filterAccount = $('accountFilter').value;
  const res = $('results');
  res.innerHTML = '';
  $('statusMsg').textContent = '';

  if(!ALL_PRODUCTS.length){
    $('statusMsg').textContent = 'Base vide ou non synchronis√©e.';
    return;
  }

  let filtered = ALL_PRODUCTS
    .filter(p=>{
      if(!q) return true;
      return (p.asin||'').includes(q) || (p.title||'').toUpperCase().includes(q);
    })
    .filter(p=>{
      if(!filterAccount) return true;
      return extractAccounts(p.history).includes(filterAccount);
    })
    .sort((a,b)=>{
      if(filterAccount){
        return lastOrderForAccount(b,filterAccount)
             - lastOrderForAccount(a,filterAccount);
      }
      return getLastOrderTimestamp(b) - getLastOrderTimestamp(a);
    });

  if(!filtered.length){
    $('statusMsg').textContent = 'Aucun r√©sultat.';
    return;
  }

  filtered.slice(0,40).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'product';

    const img = document.createElement('img');
    img.src = p.photo_url || '';
    div.appendChild(img);

    const info = document.createElement('div');
    info.innerHTML = `
      <strong>${p.title||''}</strong><br>
      <span class="badge">ASIN ${p.asin}</span>
      <span class="badge">${p.orders_count} cmd</span>
    `;

    const hist = document.createElement('div');
    hist.className = 'history';

    (p.history||[])
      .filter(h=>!filterAccount || aliasFromEmail(h.email)===filterAccount)
      .sort((a,b)=>Date.parse(b.order_date)-Date.parse(a.order_date))
      .slice(0,6)
      .forEach(h=>{
        hist.innerHTML += `‚Ä¢ ${aliasFromEmail(h.email)} ‚Äî ${formatJJMM(h.order_date)}<br>`;
      });

    info.appendChild(hist);
    div.appendChild(info);
    res.appendChild(div);
  });
}

/* ================= SETTINGS ================= */

function toggleSettings(){
  alert("R√©glages inchang√©s dans cette version stable.");
}

/* ================= INIT ================= */

// ‚ö†Ô∏è Simulation locale : la vraie version remplit ALL_PRODUCTS apr√®s sync
// üëâ ici on suppose que ta version fonctionnelle les injecte d√©j√†
</script>

</body>
</html>
