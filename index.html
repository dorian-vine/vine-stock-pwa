<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vine Stock</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111"/>
  <style>
    body{font-family:system-ui;margin:14px;max-width:880px}
    h2{margin:8px 0 6px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,select{font-size:16px;padding:10px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;font-size:13px;color:#444}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .prod{display:flex;gap:10px;align-items:flex-start}
    .prod img{width:64px;height:64px;object-fit:cover;border-radius:10px;background:#f4f4f4}
    .prod h4{margin:0 0 4px;font-size:15px}
    .prod .meta{font-size:13px;color:#555}
    .list{max-height:420px;overflow:auto;border:1px solid #eee;border-radius:12px}
    .item{padding:10px;border-bottom:1px solid #eee}
    .item:last-child{border-bottom:none}
    .ok{color:#0a7}
    .warn{color:#b60}
    .err{color:#c00}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px;text-align:left}
    .twoCol{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.twoCol{grid-template-columns:1fr 1fr}}
    .btnPrimary{background:#111;color:#fff;border:none;border-radius:12px}
    .btnGhost{background:#fff;border:1px solid #ddd;border-radius:12px}
    .btnDanger{background:#fff;border:1px solid #f2c; border-radius:12px}
    .small{font-size:13px;padding:8px 10px}
    .hidden{display:none}
  </style>
</head>
<body>

<h2>üì¶ Vine Stock (FNSKU ‚Üí ASIN)</h2>
<div class="row">
  <span class="pill" id="netPill">R√©seau: ?</span>
  <span class="pill" id="cachePill">Base: ?</span>
  <span class="pill" id="mapPill">Mapping: ?</span>
</div>
<div class="muted" style="margin-top:6px">
  Scan via Binary Eye ‚Üí colle le FNSKU ici. Si inconnu, recherche + double confirmation. Sync auto quand le r√©seau revient.
</div>

<div class="card">
  <h3 style="margin:0 0 10px">1) Scanner / coller le FNSKU</h3>
  <div class="row">
    <input id="fnsku" placeholder="FNSKU (ex: X000QEDMAD)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnClear">Effacer</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnLookup">Chercher</button>
    <button class="btnGhost" id="btnSettings">‚öôÔ∏è R√©glages</button>
    <span class="muted" id="status">Pr√™t.</span>
  </div>
</div>

<!-- PRODUIT CONNU -->
<div class="card hidden" id="knownBox">
  <h3 style="margin:0 0 10px">Produit trouv√© (FNSKU connu)</h3>
  <div class="prod" id="knownProd"></div>
  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <input id="caisseKnown" placeholder="Caisse (ex: A3)" />
    <select id="actionKnown">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveKnown">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- FNSKU INCONNU : RECHERCHE -->
<div class="card hidden" id="searchBox">
  <h3 style="margin:0 0 10px">FNSKU inconnu ‚Üí choisir le produit</h3>

  <div class="row">
    <input id="q" placeholder="Recherche (marque / mot / ASIN B0‚Ä¶)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnSearch">Rechercher</button>
  </div>
  <div class="row" style="margin-top:8px">
    <label class="muted" for="accountFilter" style="min-width:120px">Filtre compte</label>
    <select id="accountFilter" style="flex:1;min-width:260px">
      <option value="">Tous les comptes</option>
    </select>
  </div>
  <div class="muted" style="margin-top:8px">
    R√©sultats depuis la base produits locale. (Si vide: fais une mise √† jour en ligne dans R√©glages.)
  </div>

  <div class="list" id="results" style="margin-top:10px"></div>
</div>

<!-- CONFIRMATION (Option B) -->
<div class="card hidden" id="confirmBox">
  <h3 style="margin:0 0 10px">2) Double confirmation</h3>

  <div class="twoCol">
    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Produit choisi</h4>
      <div class="prod" id="confirmProd"></div>
      <div class="row" style="margin-top:10px">
        <a id="confirmLink" href="#" target="_blank" class="pill">Ouvrir Amazon</a>
        <span class="pill" id="confirmAsin">ASIN: ?</span>
        <span class="pill" id="confirmPrice">Prix: ?</span>
        <span class="pill" id="confirmCaisses">üß∫ Caisses: ‚Äî</span>
      </div>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Historique (MASTER)</h4>
      <div class="muted" id="histHint">Si offline, historique = dernier cache.</div>
      <div style="max-height:240px;overflow:auto;border:1px solid #eee;border-radius:12px">
        <table>
          <thead><tr><th>Date</th><th>Email</th></tr></thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

  <div class="row">
    <button class="btnPrimary" id="btnLink">‚úÖ Valider le lien FNSKU ‚Üí ASIN</button>
    <button class="btnGhost" id="btnChange">‚Ü©Ô∏è Changer de produit</button>
    <span class="muted" id="linkStatus"></span>
  </div>
</div>

<!-- APR√àS LIEN : RANGEMENT -->
<div class="card hidden" id="afterLinkBox">
  <h3 style="margin:0 0 10px">3) Ranger / enregistrer</h3>
  <div class="prod" id="afterProd"></div>
  <div class="row" style="margin-top:10px">
    <input id="caisseAfter" placeholder="Caisse (ex: A3)" />
    <select id="actionAfter">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveAfter">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- HISTORIQUE LOCAL (actions) -->
<div class="card">
  <h3 style="margin:0 0 10px">üïì Derni√®res actions (local)</h3>
  <div class="row">
    <button class="btnGhost small" id="btnSyncNow">Sync maintenant</button>
    <button class="btnGhost small" id="btnPullNow">Mettre √† jour base + mapping</button>
    <span class="muted" id="syncMsg"></span>
  </div>
  <div style="max-height:260px;overflow:auto;border:1px solid #eee;border-radius:12px;margin-top:10px">
    <table>
      <thead><tr><th>Date</th><th>FNSKU</th><th>ASIN</th><th>Caisse</th><th>Action</th><th>Sync</th></tr></thead>
      <tbody id="actionsTable"></tbody>
    </table>
  </div>
</div>

<!-- SETTINGS -->
<div class="card hidden" id="settingsBox">
  <h3 style="margin:0 0 10px">‚öôÔ∏è R√©glages</h3>
  <div class="muted">Colle ici l‚ÄôURL /exec de ton Apps Script + ton SECRET.</div>
  <div class="row" style="margin-top:10px">
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;min-width:280px"/>
    <input id="secret" placeholder="SECRET" style="min-width:180px"/>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnSaveSettings">Enregistrer</button>
    <button class="btnGhost" id="btnCloseSettings">Fermer</button>
    <span class="muted" id="settingsStatus"></span>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <button class="btnGhost" id="btnResetCache">R√©initialiser cache local</button>
    <span class="muted">‚ö†Ô∏è Efface base produits, mapping et actions non sync.</span>
  </div>
</div>

<script>
/* PWA cache */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }

const $ = (id)=>document.getElementById(id);
const netPill=$('netPill'), cachePill=$('cachePill'), mapPill=$('mapPill');

const LS = {
  apiUrl: 'vine_api_url',
  secret: 'vine_secret',
  device: 'vine_device',
  lastCaisse: 'vine_last_caisse',
  lastPull: 'vine_last_pull',
  caisseMap: 'vine_caisse_by_asin',
  actionsCursor: 'vine_actions_cursor'
};

const deviceId = localStorage.getItem(LS.device) || (()=> {
  const v='phone_'+Math.random().toString(16).slice(2,8);
  localStorage.setItem(LS.device, v);
  return v;
})();

let apiUrl = localStorage.getItem(LS.apiUrl) || '';
let secret = localStorage.getItem(LS.secret) || '';
let lastCaisse = (localStorage.getItem(LS.lastCaisse) || '').toUpperCase();

$('apiUrl').value = apiUrl;
$('secret').value = secret;

const DB_NAME='vine_global', DB_VER=1;
let db;

/* IndexedDB stores:
  - products (key asin) => {asin,title,photo_url,product_url,price,orders_count,history}
  - mapping (key fnsku) => {fnsku,asin,linked_at,device}
  - actions (auto id) => {id,ts,device,fnsku,asin,caisse,action,synced:false}
*/
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded=()=>{
      const d=r.result;
      if(!d.objectStoreNames.contains('products')) d.createObjectStore('products', {keyPath:'asin'});
      if(!d.objectStoreNames.contains('mapping')) d.createObjectStore('mapping', {keyPath:'fnsku'});
      if(!d.objectStoreNames.contains('actions')) d.createObjectStore('actions', {keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}

function idbPut(store, val){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(val);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result||null);
    req.onerror=()=>rej(req.error);
  });
}
function idbGetAll(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).getAll();
    req.onsuccess=()=>res(req.result||[]);
    req.onerror=()=>rej(req.error);
  });
}
function idbDelAll(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).clear();
    req.onsuccess=()=>res();
    req.onerror=()=>rej(req.error);
  });
}

/* Helpers */
function setStatus(msg, cls=''){
  $('status').textContent = msg;
  $('status').className = 'muted ' + cls;
}
function online(){ return navigator.onLine; }

function normFnsku(v){
  return (v||'').toString().trim().toUpperCase();
}

// Recherche non sensible aux accents (√©=e, √†=a, √ß=c)
function foldText(s){
  return (s||'').toString()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toUpperCase();
}

// Caisses par ASIN (plusieurs caisses possibles)
function getCaisseMap(){
  try{ return JSON.parse(localStorage.getItem(LS.caisseMap) || '{}') || {}; }
  catch(e){ return {}; }
}
function getCaissesForAsin(asin){
  asin = normAsin(asin);
  const m = getCaisseMap();
  const v = m[asin];
  return Array.isArray(v) ? v : [];
}
function setCaissesForAsin(asin, caisses){
  asin = normAsin(asin);
  const m = getCaisseMap();
  const clean = Array.from(new Set(
    (caisses||[])
      .map(x=>String(x||'').trim().toUpperCase())
      .filter(Boolean)
  ));
  if(clean.length) m[asin] = clean; else delete m[asin];
  localStorage.setItem(LS.caisseMap, JSON.stringify(m));
}
function applyCaisseAction(asin, caisse, action){
  asin = normAsin(asin);
  caisse = (caisse||'').toString().trim().toUpperCase();
  action = (action||'').toString().trim().toUpperCase();
  if(!asin || !/^[A-Z0-9]{10}$/.test(asin) || !caisse) return;

  const cur = getCaissesForAsin(asin);
  if(action === 'REMOVE' || action === 'SOLD'){
    setCaissesForAsin(asin, cur.filter(c=>c!==caisse));
  }else{
    // ADD / MOVE / autres ‚Üí on ajoute la caisse (multi-caisses)
    cur.push(caisse);
    setCaissesForAsin(asin, cur);
  }
}


// ====== Caisses <-> MAPPING (optionnel) ======
function parseCaissesField(v){
  if(v==null) return [];
  const s = String(v).trim();
  if(!s) return [];
  return s
    .split(/[,;
	]+/g)
    .map(x=>String(x||'').trim())
    .filter(Boolean)
    .map(x=>x.toUpperCase());
}

function mergeCaissesFromMapping(asin, caissesField){
  asin = normAsin(asin);
  if(!asin) return;
  const incoming = parseCaissesField(caissesField);
  if(!incoming.length) return;
  const current = getCaissesForAsin(asin);
  const set = new Set([...current, ...incoming]);
  setCaissesForAsin(asin, [...set]);
}

const _caisseSyncTimers = new Map();
async function queueSyncCaissesToMapping(asin){
  // Best-effort: si le backend ne supporte pas l'op, on ignore.
  asin = normAsin(asin);
  if(!asin) return;
  if(!online()) return;
  const apiUrl = localStorage.getItem(LS.apiUrl) || '';
  const secret = localStorage.getItem(LS.secret) || '';
  if(!apiUrl || !secret) return;

  if(_caisseSyncTimers.has(asin)) clearTimeout(_caisseSyncTimers.get(asin));
  _caisseSyncTimers.set(asin, setTimeout(async ()=>{
    try{
      const caisses = getCaissesForAsin(asin);
      // On tente un op optionnel "set_caisses".
      // Si ton Apps Script ne le g√®re pas encore, il r√©pondra unknown op et on ignore.
      await apiPost({ op:'set_caisses', secret, asin, caisses });
    }catch(_){ /* ignore */ }
  }, 900));
}
function normAsin(v){
  v=(v||'').toString().trim().toUpperCase();
  const m=v.match(/\/dp\/([A-Z0-9]{10})/i);
  if(m) return m[1].toUpperCase();
  const m2=v.match(/ASIN[:\s]*([A-Z0-9]{10})/i);
  if(m2) return m2[1].toUpperCase();
  return v;
}

function fmtDate(ts){
  if(!ts) return '';
  return ts.toString().slice(0,16).replace('T',' ');
}

/* Dates + tri (Option A: 1 date par compte = 1√®re commande) */
function jjmm(dateStr){
  if(!dateStr) return '';
  // Supporte "YYYY-MM-DD HH:MM:SS" et ISO
  const s = String(dateStr).trim().replace(' ', 'T');
  const d = new Date(s);
  if(isNaN(d)) return '';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${dd}/${mm}`;
}

function aliasFromEmail(email){
  const e = (email||'').toString().trim().toLowerCase();
  if(!e) return '';
  const local = (e.split('@')[0] || e);
  const first = local.replace(/[^a-z0-9]+/gi,' ').trim().split(' ')[0] || local;
  return first.charAt(0).toUpperCase() + first.slice(1);
}

function accountsWithFirstOrderDate(history){
  const minTsByEmail = new Map();
  (history||[]).forEach(h=>{
    const email = (h.email||'').toString().trim().toLowerCase();
    if(!email) return;
    const ts = Date.parse(String(h.order_date||'').trim().replace(' ', 'T'));
    if(isNaN(ts)) return;
    const prev = minTsByEmail.get(email);
    if(prev === undefined || ts < prev) minTsByEmail.set(email, ts);
  });

  return Array.from(minTsByEmail.entries())
    .sort((a,b)=>a[1]-b[1]) // plus ancienne d'abord
    .map(([email, ts])=>{
      const name = aliasFromEmail(email);
      const d = jjmm(new Date(ts).toISOString());
      return d ? `${name} (${d})` : name;
    });
}

// Tri par date de commande la plus r√©cente (dernier event de history)
function getLastOrderTimestamp(product){
  const hist = Array.isArray(product?.history) ? product.history : [];
  let maxTs = 0;
  for(const h of hist){
    const ts = Date.parse(String(h.order_date||'').trim().replace(' ', 'T'));
    if(!isNaN(ts) && ts > maxTs) maxTs = ts;
  }
  return maxTs;
}

// Derni√®re date (timestamp) pour un email sp√©cifique (pour tri quand filtre compte actif)
function getLastOrderTimestampForEmail(product, emailLower){
  const hist = Array.isArray(product?.history) ? product.history : [];
  let maxTs = 0;
  for(const h of hist){
    const em = (h.email||'').toString().trim().toLowerCase();
    if(!em || em !== emailLower) continue;
    const ts = Date.parse(String(h.order_date||'').trim().replace(' ', 'T'));
    if(!isNaN(ts) && ts > maxTs) maxTs = ts;
  }
  return maxTs;
}

// Construit la liste des emails de comptes pr√©sents dans la base (unique)
function collectAccountEmails(products){
  const set = new Set();
  for(const p of (products||[])){
    const hist = Array.isArray(p?.history) ? p.history : [];
    for(const h of hist){
      const em = (h.email||'').toString().trim().toLowerCase();
      if(em) set.add(em);
    }
  }
  return Array.from(set).sort();
}


function prodHTML(p){
  const img = p.photo_url
    ? `<img src="${p.photo_url}" alt="">`
    : `<div class="ph">üì¶</div>`;

  const price = p.price ? ` ¬∑ <b>${p.price}</b>` : '';

  // Comptes + date JJ/MM
  const acc = accountsWithFirstOrderDate(p.history || []);
  const cnt = acc.length
    ? ` ¬∑ üë§ ${acc.length} comptes: ${acc.join(' ¬∑ ')}`
    : '';

  const caisses = getCaissesForAsin(p.asin);
  const cBadge = caisses.length ? ` ¬∑ üß∫ ${escapeHtml(caisses.join(' ¬∑ '))}` : '';
  return `
    ${img}
    <div>
      <h4>${escapeHtml(p.title || '')}</h4>
      <div class="meta">
        ASIN: <b>${p.asin}</b>${price}${cnt}${cBadge}
      </div>
      <div class="meta">
        ${p.product_url ? `<a href="${p.product_url}" target="_blank">Lien produit</a>` : ''}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
}

async function refreshPills(){
  netPill.textContent = 'R√©seau: ' + (online() ? 'ONLINE' : 'OFFLINE');
  netPill.className = 'pill ' + (online() ? 'ok' : 'warn');

  const prodCount = (await idbGetAll('products')).length;
  cachePill.textContent = 'Base: ' + prodCount + ' ASIN';
  cachePill.className = 'pill ' + (prodCount>0 ? 'ok' : 'warn');

  const mapCount = (await idbGetAll('mapping')).length;
  mapPill.textContent = 'Mapping: ' + mapCount;
  mapPill.className = 'pill ' + (mapCount>0 ? 'ok' : 'warn');
}

async function renderActions(){
  const actions = (await idbGetAll('actions'))
    .sort((a,b)=> (b.ts||'').localeCompare(a.ts||''))
    .slice(0,60);
  $('actionsTable').innerHTML = actions.map(a=>`
    <tr>
      <td>${fmtDate(a.ts)}</td>
      <td>${escapeHtml(a.fnsku||'')}</td>
      <td>${escapeHtml(a.asin||'')}</td>
      <td>${escapeHtml(a.caisse||'')}</td>
      <td>${escapeHtml(a.action||'')}</td>
      <td>${a.synced ? '‚úî' : '‚Ä¶'}</td>
    </tr>
  `).join('');
}

function showOnly(boxId){
  const ids=['knownBox','searchBox','confirmBox','afterLinkBox','settingsBox'];
  ids.forEach(id=>$(id).classList.add('hidden'));
  if(boxId) $(boxId).classList.remove('hidden');
}

function proposeCaisse(){
  const c = (localStorage.getItem(LS.lastCaisse) || '').toUpperCase();
  $('caisseKnown').value = c;
  $('caisseAfter').value = c;
}

/* API */
function fetchWithTimeout(url, options = {}, ms = 15000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, {...options, signal: ctrl.signal}).finally(()=>clearTimeout(id));
}

async function apiGet(params){
  if(!apiUrl || !secret) throw new Error('R√©glages manquants (API_URL/SECRET)');
  const u = new URL(apiUrl);
  u.searchParams.set('secret', secret);
  Object.entries(params||{}).forEach(([k,v])=>u.searchParams.set(k,v));
  // timeout + anti-cache
  u.searchParams.set('_', String(Date.now()));
  const r = await fetchWithTimeout(u.toString(), {method:'GET'}, 15000);
  if(!r.ok) throw new Error('HTTP_'+r.status);
  return await r.json();
}
async function apiPost(body){
  if(!apiUrl || !secret) throw new Error('R√©glages manquants (API_URL/SECRET)');
  // IMPORTANT: Apps Script + CORS -> on envoie en text/plain pour √©viter le pr√©flight bloquant
  const payload = JSON.stringify({secret, ...body});
  const r = await fetchWithTimeout(apiUrl, {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: payload
  }, 15000);
  if(!r.ok) throw new Error('HTTP_'+r.status);
  return await r.json();
}

/* Pull master + mapping */
async function pullAll(){
  if(!online()) return;
  if(!apiUrl || !secret) return;

  $('syncMsg').textContent = '‚è≥ Mise √† jour base + mapping...';
  try{
    const [m1, m2] = await Promise.all([
      apiGet({op:'pull_master_full'}),
      apiGet({op:'pull_mapping'})
    ]);

    if(m1.ok && Array.isArray(m1.products)){
      for(const p of m1.products){
        // Normalise
        p.asin = normAsin(p.asin);
        p.history = Array.isArray(p.history) ? p.history : [];
        await idbPut('products', p);
      }
      localStorage.setItem(LS.lastPull, new Date().toISOString());
    }

    if(m2.ok && Array.isArray(m2.mapping)){
      for(const it of m2.mapping){
        it.fnsku = normFnsku(it.fnsku);
        it.asin = normAsin(it.asin);
        // Si la colonne caisses existe dans MAPPING, on l'absorbe automatiquement
        const caField = (it.caisses ?? it.caisse ?? it.caisse_s ?? it.boxes ?? it.caisse_list ?? '');
        mergeCaissesFromMapping(it.asin, caField);
        await idbPut('mapping', it);
      }
    }

    $('syncMsg').textContent = '‚úÖ Base + mapping √† jour';
  }catch(e){
    $('syncMsg').textContent = '‚ùå Pull impossible ('+ (e.message||e) +')';
  }
  await refreshPills();
}

/* Push actions */
async function pushActions(){
  if(!online()) return;
  if(!apiUrl || !secret) return;

  const all = await idbGetAll('actions');
  const pending = all.filter(a=>!a.synced);

  if(!pending.length) return;

  $('syncMsg').textContent = '‚è≥ Sync actions ('+pending.length+')...';

  try{
    const resp = await apiPost({op:'push_actions', actions: pending});
    if(resp.ok){
      // mark synced (we re-put by id)
      const appended = resp.appended || 0;
      const skipped = resp.skipped || 0;

      // safest: mark everything we attempted as synced (ids are unique, server dedup)
      for(const a of pending){
        a.synced = true;
        await idbPut('actions', a);
      }

      $('syncMsg').textContent = `‚úÖ Sync OK (app:${appended}, skip:${skipped})`;
      await renderActions();
    }else{
      $('syncMsg').textContent = '‚ùå Sync refus√©e: '+(resp.error||'');
    }
  }catch(e){
    $('syncMsg').textContent = '‚ùå Sync impossible (r√©seau)';
  }
}


/* Pull STOCK_ACTIONS (cursor) + reconstruire les caisses (global multi-t√©l√©phones) */
async function pullStockActions(){
  if(!online()) return {pulled:0};
  if(!apiUrl || !secret) return {pulled:0};

  // 1√®re fois : on reconstruit depuis le d√©but (cursor=1 = header)
  let cursor = Number(localStorage.getItem(LS.actionsCursor) || '0');
  if(!cursor){
    cursor = 1;
    // reset caisse map pour repartir proprement (source de v√©rit√© = STOCK_ACTIONS)
    localStorage.setItem(LS.caisseMap, JSON.stringify({}));
    localStorage.setItem(LS.lastCaisse, '');
    lastCaisse = '';
  }

  const LIMIT = 500;
  let total = 0;

  while(true){
    const resp = await apiGet({op:'pull_actions', cursor:String(cursor), limit:String(LIMIT)});
    if(!resp.ok) throw new Error(resp.error || 'pull_actions failed');

    const actions = Array.isArray(resp.actions) ? resp.actions : [];
    if(!actions.length){
      localStorage.setItem(LS.actionsCursor, String(cursor));
      break;
    }

    // Assure ordre par ligne
    actions.sort((a,b)=>(Number(a.row||0)-Number(b.row||0)));

    for(const a of actions){
      const asin = normAsin(a.asin||'');
      const caisse = (a.caisse||'').toString().trim().toUpperCase();
      const act = (a.action||'').toString().trim().toUpperCase();

      // Reconstruit caisses multi-caisses depuis le journal
      if(asin && caisse){
        applyCaisseAction(asin, caisse, act);
        // last caisse globale = derni√®re caisse vue dans le journal
        localStorage.setItem(LS.lastCaisse, caisse);
        lastCaisse = caisse;
      }
      total += 1;
    }

    // Avance le cursor √† la derni√®re ligne renvoy√©e
    cursor = Number(resp.next_cursor || cursor);

    // si batch incomplet -> fini
    if(actions.length < LIMIT){
      localStorage.setItem(LS.actionsCursor, String(cursor));
      break;
    }
  }

  // Met √† jour les champs de saisie caisse (proposition)
  proposeCaisse();

  return {pulled: total, cursor};
}


/* Auto sync: when online => push then pull */
let syncLock=false;
async function autoSync(){
  if(syncLock) return;
  if(!online()) return;
  if(!apiUrl || !secret) return;
  syncLock=true;
  try{
    await pushActions();
    // Phase 2 (recommand√©e) : on pull STOCK_ACTIONS et on reconstruit les caisses globales
    try{
      const r = await pullStockActions();
      if(r && r.pulled){
        $('syncMsg').textContent = `‚úÖ Stock actions mises √† jour (+${r.pulled})`;
      }
    }catch(e){
      // on n'emp√™che pas la suite (base + mapping)
      $('syncMsg').textContent = '‚ö†Ô∏è Stock actions: '+(e.message||e);
    }
    await pullAll();
  }finally{
    syncLock=false;
  }
}

/* Lookup flow */
let currentFnsku='', selectedProduct=null;

async function lookupFnsku(){
  currentFnsku = normFnsku($('fnsku').value);
  $('fnsku').value = currentFnsku;
  if(!currentFnsku){ setStatus('FNSKU vide', 'warn'); return; }

  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');

  setStatus('Recherche mapping...', '');
  const mapped = await idbGet('mapping', currentFnsku);

  if(mapped && mapped.asin){
    const asin = normAsin(mapped.asin);
    const p = await idbGet('products', asin);
    if(p){
      $('knownProd').innerHTML = prodHTML(p);
    }else{
      $('knownProd').innerHTML = `<div class="muted warn">Produit non trouv√© dans la base locale (ASIN: ${asin}). Fais une mise √† jour en ligne.</div>`;
    }
    proposeCaisse();
    showOnly('knownBox');
    setStatus('FNSKU connu.', 'ok');
    return;
  }

  // Unknown => search
  showOnly('searchBox');
  setStatus('FNSKU inconnu ‚Üí recherche produit.', 'warn');
  $('q').value = '';
  $('results').innerHTML = '';
  $('q').focus();
}

/* Search products */
async function doSearch(){
  const qRaw = ($('q').value||'').trim();
  const q = qRaw.toUpperCase();
  const qFold = foldText(qRaw);
  const all = await idbGetAll('products');

  // Remplit le filtre compte (une seule fois) √† partir des donn√©es locales
  const selEl = $('accountFilter');
  if(selEl && selEl.options && selEl.options.length <= 1){
    const emails = collectAccountEmails(all); // tri√©s
    for(const em of emails){
      const opt = document.createElement('option');
      opt.value = em;
      opt.textContent = aliasFromEmail(em);
      selEl.appendChild(opt);
    }
  }

  const accEmail = selEl ? (selEl.value||'').trim().toLowerCase() : '';

  if(!all.length){
    $('results').innerHTML = `<div class="item"><div class="muted err">Base produits vide. Va dans ‚öôÔ∏è R√©glages, puis ‚ÄúMettre √† jour base + mapping‚Äù.</div></div>`;
    return;
  }

  let filtered = all
    .filter(p=>{
      const tFold = foldText(p.title||'');
      const asin=(p.asin||'').toString().toUpperCase();
      // Recherche sur titre / ASIN
      return !qFold || tFold.includes(qFold) || asin.includes(q);
    })
    .filter(p=>{
      if(!accEmail) return true;
      const hist = Array.isArray(p?.history) ? p.history : [];
      return hist.some(h => (h.email||'').toString().trim().toLowerCase() === accEmail);
    })
    .sort((a,b)=>{
      // Tri par date de commande la plus r√©cente
      const tb = accEmail ? getLastOrderTimestampForEmail(b, accEmail) : getLastOrderTimestamp(b);
      const ta = accEmail ? getLastOrderTimestampForEmail(a, accEmail) : getLastOrderTimestamp(a);
      if(tb !== ta) return tb - ta; // plus r√©cent en premier
      return (b.orders_count||0) - (a.orders_count||0); // fallback
    })
    .slice(0,60);

  if(!filtered.length){
    $('results').innerHTML = `<div class="item"><div class="muted warn">Aucun r√©sultat.</div></div>`;
    return;
  }

  $('results').innerHTML = filtered.map(p=>`
    <div class="item">
      <div class="prod">${prodHTML(p)}</div>
      <div class="row" style="margin-top:8px">
        <button class="btnPrimary small" data-asin="${p.asin}">S√©lectionner</button>
        <span class="pill">cmd: ${p.orders_count||0}</span>
      </div>
    </div>
  `).join('');

  // bind select buttons
  $('results').querySelectorAll('button[data-asin]').forEach(btn=>{
    btn.onclick=async ()=>{
      const asin = btn.getAttribute('data-asin');
      selectedProduct = await idbGet('products', asin);
      await showConfirm();
    };
  });
}
async function showConfirm(){
  if(!selectedProduct) return;
  showOnly('confirmBox');
  $('confirmProd').innerHTML = prodHTML(selectedProduct);
  $('confirmLink').href = selectedProduct.product_url || '#';
  $('confirmAsin').textContent = 'ASIN: ' + selectedProduct.asin;
  $('confirmPrice').textContent = 'Prix: ' + (selectedProduct.price || '‚Äî');
  const cc = getCaissesForAsin(selectedProduct.asin);
  $('confirmCaisses').textContent = 'üß∫ Caisses: ' + (cc.length ? cc.join(' ¬∑ ') : '‚Äî');

  const hist = Array.isArray(selectedProduct.history) ? selectedProduct.history : [];
  $('histTable').innerHTML = hist.slice(0,80).map(h=>`
    <tr><td>${escapeHtml((h.order_date||'').toString())}</td><td>${escapeHtml((h.email||'').toString())}</td></tr>
  `).join('') || `<tr><td colspan="2" class="muted">Aucun historique en cache.</td></tr>`;

  $('linkStatus').textContent = '';
}

async function linkFnsku(){
  if(!selectedProduct) return;
  const fnsku = currentFnsku;
  const asin = selectedProduct.asin;

  if(!online()){
    $('linkStatus').textContent = '‚ùå Impossible de lier sans internet (global apr√®s synchro).';
    $('linkStatus').className = 'muted err';
    return;
  }
  if(!apiUrl || !secret){
    $('linkStatus').textContent = '‚ùå R√©glages API manquants.';
    $('linkStatus').className = 'muted err';
    return;
  }

  $('linkStatus').textContent = '‚è≥ Liaison en cours...';
  $('linkStatus').className = 'muted';

  const resp = await apiPost({op:'link_fnsku', fnsku, asin, device: deviceId, linked_at: new Date().toISOString(), caisses: getCaissesForAsin(asin).join(',')});
  if(resp.ok){
    // update local mapping cache
    await idbPut('mapping', {fnsku, asin, linked_at: new Date().toISOString(), device: deviceId});
    $('linkStatus').textContent = '‚úÖ Lien cr√©√©';
    $('linkStatus').className = 'muted ok';

    // proceed to action box
    $('afterProd').innerHTML = prodHTML(selectedProduct);
    proposeCaisse();
    showOnly('afterLinkBox');
    setStatus('Lien OK ‚Üí enregistre le rangement.', 'ok');
    await refreshPills();
  }else{
    const e = resp.error || '';
    if(e.startsWith('fnsku_already_linked:')){
      const already = e.split(':')[1] || '';
      $('linkStatus').textContent = '‚ö†Ô∏è D√©j√† li√© √† ' + already;
      $('linkStatus').className = 'muted warn';
      // pull mapping to update
      await pullAll();
    }else{
      $('linkStatus').textContent = '‚ùå ' + e;
      $('linkStatus').className = 'muted err';
    }
  }
}

async function saveAction({fnsku, asin, caisse, action}){
  fnsku = normFnsku(fnsku);
  asin = normAsin(asin);
  caisse = (caisse||'').toString().trim().toUpperCase();
  action = (action||'').toString().trim().toUpperCase();

  if(!fnsku){ alert('FNSKU manquant'); return; }
  if(!asin || !/^[A-Z0-9]{10}$/.test(asin)){ alert('ASIN invalide'); return; }
  if(!caisse){ alert('Caisse obligatoire'); return; }

  // update last caisse global
  localStorage.setItem(LS.lastCaisse, caisse);
  // update caisses per ASIN (multi-caisses)
  applyCaisseAction(asin, caisse, action);
    // Optionnel: synchroniser les caisses vers MAPPING (si backend supporte)
    queueSyncCaissesToMapping(asin);

  const id = deviceId + '_' + Date.now().toString(36) + '_' + Math.random().toString(16).slice(2,6);
  const row = {
    id,
    ts: new Date().toISOString(),
    device: deviceId,
    fnsku,
    asin,
    caisse,
    action,
    synced: false
  };
  await idbPut('actions', row);
  await renderActions();
  await refreshPills();

  setStatus('Action enregistr√©e offline.', 'ok');

  // auto sync if online
  autoSync();
}

/* UI bindings */
$('btnLookup').onclick = lookupFnsku;
$('btnClear').onclick = ()=>{
  $('fnsku').value='';
  $('q').value='';
  $('results').innerHTML='';
  selectedProduct=null;
  currentFnsku='';
  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');
  setStatus('Pr√™t.', '');
  $('fnsku').focus();
};

$('btnSearch').onclick = doSearch;
$('accountFilter').addEventListener('change', ()=>doSearch());
$('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

$('btnLink').onclick = linkFnsku;
$('btnChange').onclick = ()=>{
  showOnly('searchBox');
  $('linkStatus').textContent='';
};

$('btnSaveKnown').onclick = async ()=>{
  const fnsku = currentFnsku;
  const mapped = await idbGet('mapping', fnsku);
  const asin = mapped ? mapped.asin : '';
  await saveAction({fnsku, asin, caisse:$('caisseKnown').value, action:$('actionKnown').value});
};

$('btnSaveAfter').onclick = async ()=>{
  await saveAction({fnsku: currentFnsku, asin: selectedProduct.asin, caisse:$('caisseAfter').value, action:$('actionAfter').value});
};

$('btnSettings').onclick = ()=>{ $('settingsBox').classList.toggle('hidden'); };
$('btnCloseSettings').onclick = ()=>{ $('settingsBox').classList.add('hidden'); };

$('btnSaveSettings').onclick = async ()=>{
  apiUrl = ($('apiUrl').value||'').trim();
  secret = ($('secret').value||'').trim();
  localStorage.setItem(LS.apiUrl, apiUrl);
  localStorage.setItem(LS.secret, secret);
  $('settingsStatus').textContent = '‚úÖ Sauv√©. Fais ‚ÄúMettre √† jour base + mapping‚Äù.';
  await refreshPills();
};

$('btnResetCache').onclick = async ()=>{
  if(!confirm('Effacer base produits + mapping + actions locales ?')) return;
  await idbDelAll('products');
  await idbDelAll('mapping');
  await idbDelAll('actions');
  localStorage.removeItem(LS.lastPull);
  $('syncMsg').textContent='';
  setStatus('Cache effac√©.', 'warn');
  await renderActions();
  await refreshPills();
};

$('btnSyncNow').onclick = autoSync;
$('btnPullNow').onclick = pullAll;

/* Auto sync triggers */
window.addEventListener('online', ()=>{
  refreshPills();
  $('syncMsg').textContent = 'üåê R√©seau revenu ‚Üí sync auto...';
  autoSync();
});
window.addEventListener('offline', refreshPills);

// auto sync every 45s when online (lightweight)
setInterval(()=>{ if(online()) autoSync(); }, 45000);

/* Init */
(async function init(){
  db = await openDB();
  await refreshPills();
  await renderActions();

  // Autofocus for paste flow
  $('fnsku').focus();

  // If online and configured, pull base early
  if(online() && apiUrl && secret){
    await pullAll();
  }
})();
</script>
  <script>
(function () {

  function findFnskuInput() {
    // 1Ô∏è‚É£ priorit√© au placeholder FNSKU
    let el = [...document.querySelectorAll('input')]
      .find(i =>
        i.placeholder &&
        i.placeholder.toLowerCase().includes('fnsku')
      );

    if (el) return el;

    // 2Ô∏è‚É£ fallback : premier input texte visible
    el = [...document.querySelectorAll('input[type="text"]')]
      .find(i => i.offsetParent !== null);

    return el || null;
  }

  function focusAndSelect() {
    const input = findFnskuInput();
    if (!input) return;

    // petit d√©lai pour Android / PWA
    setTimeout(() => {
      input.focus();
      input.select();
    }, 80);
  }

  // üîÅ quand on revient depuis une autre app (Binary Eye)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      focusAndSelect();
    }
  });

  // üîÅ au retour arri√®re Android
  window.addEventListener('pageshow', focusAndSelect);

  // üîÅ premier chargement
  window.addEventListener('load', focusAndSelect);

})();
</script>
</body>
</html>
