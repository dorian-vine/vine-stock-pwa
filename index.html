<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vine Stock</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111"/>
  <style>
    body{font-family:system-ui;margin:14px;max-width:880px}
    h2{margin:8px 0 6px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,select{font-size:16px;padding:10px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;font-size:13px;color:#444}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .prod{display:flex;gap:10px;align-items:flex-start}
    .prod img{width:64px;height:64px;object-fit:cover;border-radius:10px;background:#f4f4f4}
    .prod h4{margin:0 0 4px;font-size:15px}
    .prod .meta{font-size:13px;color:#555}
    .list{max-height:420px;overflow:auto;border:1px solid #eee;border-radius:12px}
    .item{padding:10px;border-bottom:1px solid #eee}
    .item:last-child{border-bottom:none}
    .ok{color:#0a7}
    .warn{color:#b60}
    .err{color:#c00}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px;text-align:left}
    .twoCol{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.twoCol{grid-template-columns:1fr 1fr}}
    .btnPrimary{background:#111;color:#fff;border:none;border-radius:12px}
    .btnGhost{background:#fff;border:1px solid #ddd;border-radius:12px}
    .btnDanger{background:#fff;border:1px solid #f2c; border-radius:12px}
    .small{font-size:13px;padding:8px 10px}
    .hidden{display:none}
  </style>
</head>
<body>

<h2>üì¶ Vine Stock (FNSKU ‚Üí ASIN)</h2>
<div class="row">
  <span class="pill" id="netPill">R√©seau: ?</span>
  <span class="pill" id="cachePill">Base: ?</span>
  <span class="pill" id="mapPill">Mapping: ?</span>
</div>
<div class="muted" style="margin-top:6px">
  Scan via üì∑ cam√©ra (bouton Scanner) ou via Binary Eye ‚Üí colle le FNSKU ici. Si inconnu, recherche + double confirmation. Sync auto quand le r√©seau revient.
</div>

<div class="card">
  <h3 style="margin:0 0 10px">1) Scanner / coller le FNSKU</h3>
  <div class="row">
    <input id="fnsku" placeholder="FNSKU (ex: X000QEDMAD)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnScanCam">üì∑ Scanner</button>
    <button class="btnGhost" id="btnClear">Effacer</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnLookup">Chercher</button>
    <button class="btnGhost" id="btnSettings">‚öôÔ∏è R√©glages</button>
    <span class="muted" id="status">Pr√™t.</span>
  </div>
</div>

<!-- CAMERA SCAN OVERLAY (Android Chrome) -->
<div id="scanOverlay" style="display:none; position:fixed; inset:0; background:#000; z-index:9999;">
  <video id="scanVideo" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>

  <!-- Cadre visuel -->
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
    <div style="width:min(80vw,420px); height:180px; border:2px solid rgba(255,255,255,.9); border-radius:16px;"></div>
  </div>

  <!-- Barre top -->
  <div style="position:absolute; top:0; left:0; right:0; padding:12px; display:flex; gap:10px; align-items:center;">
    <button id="btnStopScan" class="btn" style="background:#fff; color:#000; border:none; border-radius:12px; padding:10px 12px; font-size:16px;">‚úï Fermer</button>
    <button id="btnTorch" class="btn" style="background:rgba(255,255,255,.15); color:#fff; border:1px solid rgba(255,255,255,.35); border-radius:12px; padding:10px 12px; font-size:16px;">üî¶ Flash</button>
    <div id="scanMsg" style="color:#fff; font-weight:600;"></div>
  </div>
</div>

<!-- PRODUIT CONNU -->
<div class="card hidden" id="knownBox">
  <h3 style="margin:0 0 10px">Produit trouv√© (FNSKU connu)</h3>
  <div class="prod" id="knownProd"></div>
  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <input id="caisseKnown" placeholder="Caisse (ex: A3)" />
    <select id="actionKnown">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveKnown">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- FNSKU INCONNU : RECHERCHE -->
<div class="card hidden" id="searchBox">
  <h3 style="margin:0 0 10px">FNSKU inconnu ‚Üí choisir le produit</h3>

  <div class="row">
    <input id="q" placeholder="Recherche (marque / mot / ASIN B0‚Ä¶)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnSearch">Rechercher</button>
  </div>
  <div class="row" style="margin-top:8px">
    <label class="muted" for="accountFilter" style="min-width:120px">Filtre compte</label>
    <select id="accountFilter" style="flex:1;min-width:260px">
      <option value="">Tous les comptes</option>
    </select>
  </div>
  <div class="muted" style="margin-top:8px">
    R√©sultats depuis la base produits locale. (Si vide: fais une mise √† jour en ligne dans R√©glages.)
  </div>

  <div class="list" id="results" style="margin-top:10px"></div>
</div>

<!-- CONFIRMATION (Option B) -->
<div class="card hidden" id="confirmBox">
  <h3 style="margin:0 0 10px">2) Double confirmation</h3>

  <div class="twoCol">
    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Produit choisi</h4>
      <div class="prod" id="confirmProd"></div>
      <div class="row" style="margin-top:10px">
        <a id="confirmLink" href="#" target="_blank" class="pill">Ouvrir Amazon</a>
        <span class="pill" id="confirmAsin">ASIN: ?</span>
        <span class="pill" id="confirmPrice">Prix: ?</span>
        <span class="pill" id="confirmCaisses">üß∫ Stock global: ‚Äî</span>
      </div>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Historique (MASTER)</h4>
      <div class="muted" id="histHint">Si offline, historique = dernier cache.</div>
      <div style="max-height:240px;overflow:auto;border:1px solid #eee;border-radius:12px">
        <table>
          <thead><tr><th>Date</th><th>Email</th></tr></thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

  <div class="row">
    <button class="btnPrimary" id="btnLink">‚úÖ Valider le lien FNSKU ‚Üí ASIN</button>
    <button class="btnGhost" id="btnChange">‚Ü©Ô∏è Changer de produit</button>
    <span class="muted" id="linkStatus"></span>
  </div>
</div>

<!-- APR√àS LIEN : RANGEMENT -->
<div class="card hidden" id="afterLinkBox">
  <h3 style="margin:0 0 10px">3) Ranger / enregistrer</h3>
  <div class="prod" id="afterProd"></div>
  <div class="row" style="margin-top:10px">
    <input id="caisseAfter" placeholder="Caisse (ex: A3)" />
    <select id="actionAfter">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveAfter">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- HISTORIQUE LOCAL (actions) -->
<div class="card">
  <h3 style="margin:0 0 10px">üïì Derni√®res actions (local)</h3>
  <div class="row">
    <button class="btnGhost small" id="btnSyncNow">Sync maintenant</button>
    <button class="btnGhost small" id="btnPullNow">Mettre √† jour base + mapping</button>
    <button class="btnGhost small" id="btnRebuildState">Rebuild stock (serveur)</button>

    <span class="muted" id="syncMsg"></span>
  </div>
  <div style="max-height:260px;overflow:auto;border:1px solid #eee;border-radius:12px;margin-top:10px">
    <table>
      <thead><tr><th>Date</th><th>FNSKU</th><th>ASIN</th><th>Caisse</th><th>Action</th><th>Sync</th></tr></thead>
      <tbody id="actionsTable"></tbody>
    </table>
  </div>
</div>

<!-- SETTINGS -->
<div class="card hidden" id="settingsBox">
  <h3 style="margin:0 0 10px">‚öôÔ∏è R√©glages</h3>
  <div class="muted">Colle ici l‚ÄôURL /exec de ton Apps Script + ton SECRET.</div>
  <div class="row" style="margin-top:10px">
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;min-width:280px"/>
    <input id="secret" placeholder="SECRET" style="min-width:180px"/>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnSaveSettings">Enregistrer</button>
    <button class="btnGhost" id="btnCloseSettings">Fermer</button>
    <span class="muted" id="settingsStatus"></span>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <button class="btnGhost" id="btnResetCache">R√©initialiser cache local</button>
    <span class="muted">‚ö†Ô∏è Efface base produits, mapping et actions non sync.</span>
  </div>
</div>

<script>
/* PWA cache */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }

const $ = (id)=>document.getElementById(id);
const netPill=$('netPill'), cachePill=$('cachePill'), mapPill=$('mapPill');

const LS = {
  apiUrl: 'vine_api_url',
  secret: 'vine_secret',
  device: 'vine_device',
  lastCaisse: 'vine_last_caisse',
  lastPull: 'vine_last_pull',
  caisseMap: 'vine_caisse_by_asin',
  caisseCountMap: 'vine_caisse_counts_by_asin',
  actionsCursor: 'vine_actions_cursor',
  stateMap: 'vine_state_by_fnsku'
,
  fnskuMap: 'vine_fnskuMap',
  lang: 'vine_lang'
};

const deviceId = localStorage.getItem(LS.device) || (()=>{
  const v='phone_'+Math.random().toString(16).slice(2,8);
  localStorage.setItem(LS.device, v);
  return v;
})();

let apiUrl = localStorage.getItem(LS.apiUrl) || '';
let secret = localStorage.getItem(LS.secret) || '';
let lastCaisse = (localStorage.getItem(LS.lastCaisse) || '').toUpperCase();

$('apiUrl').value = apiUrl;
$('secret').value = secret;

const DB_NAME='vine_global', DB_VER=1;
let db;

/* IndexedDB stores:
  - products (key asin) => {asin,title,photo_url,product_url,price,orders_count,history}
  - mapping (key fnsku) => {fnsku,asin,linked_at,device}
  - actions (auto id) => {id,ts,device,fnsku,asin,caisse,action,synced:false}
*/
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded=()=>{
      const d=r.result;
      if(!d.objectStoreNames.contains('products')) d.createObjectStore('products', {keyPath:'asin'});
      if(!d.objectStoreNames.contains('mapping')) d.createObjectStore('mapping', {keyPath:'fnsku'});
      if(!d.objectStoreNames.contains('actions')) d.createObjectStore('actions', {keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}

function idbPut(store, val){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(val);
    tx.oncomplete=()=>res();
  });
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result||null);
    req.onerror=()=>rej(req.error);
  });
}
function idbCursor(store, opt){
  return new Promise((res,rej)=>{
    const all=[];
    const tx=db.transaction(store,'readonly');
    tx.objectStore(store).openCursor(opt).onsuccess = (e)=>{
      const cursor = e.target.result;
      if(cursor){ all.push(cursor.value); cursor.continue(); }
      else res(all);
    };
    tx.onerror=()=>rej(tx.error);
  });
}
function idbDelAll(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

/* Simple helpers */
const online = ()=> navigator.onLine;
function setStatus(msg, cls){
  const st=$('status');
  st.textContent = msg;
  st.className = 'muted ' + (cls||'');
}

/* Produit HTML snippet (with image, title, etc.) */
function prodHTML(prod, opt={}){
  if(!prod) return '';
  const {asin,title,photo_url,price,orders_count} = prod;
  const fn = opt.fnsku || '';
  const count = (orders_count || 0);
  const url = prod.product_url || `https://www.amazon.fr/dp/${asin}`;
  const countStr = count ? (count<10 ? `0${count}` : count) : '‚Äî';
  const caisse = opt.caisse || (localStorage.getItem(LS.caisseMap) ? JSON.parse(localStorage.getItem(LS.caisseMap))[asin]||'' : '');
  return `<img src="${photo_url||''}" alt="" onerror="this.style.display='none'"/>
    <div>
      <h4>${title||asin}</h4>
      <div class="meta">${fn?`FNSKU¬†: ${fn}<br>`:''}ASIN¬†: ${asin}<br>Prix¬†: ${price||'?'}</div>
    </div>`;
}

/* Map stock state to badges by caisse */
function stateBadgesForFnsku(fnsku){
  try{
    const sm = JSON.parse(localStorage.getItem(LS.stateMap) || '{}');
    const { asin, caisses } = sm[(fnsku||'').toUpperCase().trim()] || {};
    if(!caisses) return '‚Äî';
    const parts = Object.entries(caisses).map(([caisse, qty])=>{
      return `${caisse}: ${qty}`;
    });
    return parts.length ? parts.join('   ') : '‚Äî';
  }catch(e){
    return '‚Äî';
  }
}

/* MAPPING UTILS (norm) */
function normFnsku(val){ return (val||'').toString().trim().toUpperCase(); }
function normAsin(val){ return (val||'').toString().trim().toUpperCase(); }

/* Lookup produit par FNSKU (local puis online fallback) */
async function lookupFnsku(){
  const fnsku = normFnsku($('fnsku').value);
  if(!fnsku){ alert('FNSKU manquant'); return; }
  currentFnsku = fnsku;
  setStatus('‚è≥ Recherche FNSKU‚Ä¶', '');
  selectedProduct = null;
  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');

  // 1Ô∏è‚É£ local mapping
  const local = await idbGet('mapping', fnsku);
  if(local){
    const asin = local.asin;
    const prod = await idbGet('products', asin);
    if(prod){
      selectedProduct = prod;
      $('knownProd').innerHTML = prodHTML(prod, {fnsku});
      $('knownBox').classList.remove('hidden');
      setStatus('‚úÖ FNSKU connu. Produit charg√©.', 'ok');
      return;
    }
  }

  // 2Ô∏è‚É£ search online fallback
  $('searchBox').classList.remove('hidden');
  $('q').value = fnsku;
  doSearch();
}

/* Rechercher produit via mot-cl√© ou ASIN (base locale uniquement) */
async function doSearch(){
  const q = ($('q').value||'').toString().trim();
  const filter = ($('accountFilter').value||'').toString().trim();
  $('results').innerHTML = '‚è≥ Chargement‚Ä¶';
  const products = (await idbCursor('products')) || [];
  const arr = products.filter(p=>{
    const title = (p.title||'').toLowerCase();
    const asin = (p.asin||'').toUpperCase();
    if(!q) return false;
    const qry = q.toLowerCase();
    if(title.includes(qry) || asin.includes(q.toUpperCase())){
      if(filter && p.account !== filter) return false;
      return true;
    }
    return false;
  });
  if(!arr.length){
    $('results').innerHTML = '<div class="muted" style="padding:8px">Aucun r√©sultat.</div>';
    return;
  }
  $('results').innerHTML = arr.map(prod=>{
    const asin = prod.asin;
    const title = prod.title;
    const photo = prod.photo_url;
    const price = prod.price;
    const account = prod.account;
    return `<div class="item">
      <div class="prod" data-asin="${asin}">
        <img src="${photo||''}" alt="" onerror="this.style.display='none'"/>
        <div>
          <h4>${title||asin}</h4>
          <div class="meta">${account?account+'<br>':''}ASIN¬†: ${asin}<br>Prix¬†: ${price||'?'}</div>
        </div>
      </div>
    </div>`;
  }).join('');
  // click handler
  [...document.querySelectorAll('.prod[data-asin]')].forEach(el=>{
    el.onclick = async ()=>{
      const asin = el.dataset.asin;
      const prod = await idbGet('products', asin);
      if(!prod){ alert('Non trouv√© en base locale, fais ‚ÄúMettre √† jour base‚Äù dans R√©glages.'); return; }
      selectedProduct = prod;
      $('confirmProd').innerHTML = prodHTML(prod);
      $('confirmAsin').textContent = `ASIN: ${asin}`;
      $('confirmPrice').textContent = `Prix: ${prod.price||'?'}`;
      $('confirmLink').href = prod.product_url || `https://www.amazon.fr/dp/${asin}`;
      const badge = stateBadgesForFnsku(currentFnsku);
      $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (badge && badge!=='‚Äî' ? badge.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî');
      showOnly('confirmBox');
      setStatus('Choisis l‚ÄôASIN correspondant.', '');
    };
  });
}

/* Lier FNSKU ‚Üí ASIN s√©lectionn√© */
async function linkFnsku(){
  if(!currentFnsku || !selectedProduct){ alert('Donn√©es manquantes'); return; }
  const fnsku = currentFnsku;
  const asin = selectedProduct.asin;
  try{
    // persist mapping locally
    const row = { fnsku, asin, linked_at: new Date().toISOString(), device: deviceId };
    await idbPut('mapping', row);
    // mapping pill and overlay (no overlay here)
    $('mapPill').textContent = 'Mapping: ‚úÖ';
    $('mapPill').className = 'pill ok';
    // UI changes
    $('afterProd').innerHTML = prodHTML(selectedProduct, {fnsku});
    $('confirmBox').classList.add('hidden');
    $('afterLinkBox').classList.remove('hidden');
    setStatus('‚úÖ Lien FNSKU ‚Üí ASIN cr√©√© localement.', 'ok');
  }catch(e){
    $('linkStatus').textContent = '‚ùå ' + e;
    $('linkStatus').className = 'muted err';
  }
}

/* Sauvegarde action (local + try sync) */
let lastSaveKey = '';
let lastSaveAt = 0;
async function saveAction({fnsku, asin, caisse, action}){
  fnsku = normFnsku(fnsku);
  asin = normAsin(asin);
  caisse = (caisse||'').toString().trim().toUpperCase();
  action = (action||'').toString().trim().toUpperCase();

  if(!fnsku){ alert('FNSKU manquant'); return; }
  if(!asin || !/^[A-Z0-9]{10}$/.test(asin)){ alert('ASIN invalide'); return; }
  if(!caisse){ alert('Caisse obligatoire'); return; }

  // update last caisse global
  localStorage.setItem(LS.lastCaisse, caisse);
  // update caisses per ASIN (multi-caisses)
  applyQtyLocal(fnsku, asin, caisse, action);
  // refresh product detail instantly (badge in prodHTML)
  try{ if(selectedProduct){ $('knownProd').innerHTML = prodHTML(selectedProduct, {fnsku: currentFnsku}); } }catch(e){}
  // refresh product detail badge instantly
  if($('confirmCaisses')){
    const badge = stateBadgesForFnsku(fnsku);
    $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (badge && badge!=='‚Äî' ? badge.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî');
  }

  const saveKey = [fnsku, asin, caisse, action].join('|');
  const nowMs = Date.now();
  if(saveKey === lastSaveKey && (nowMs - lastSaveAt) < 1200){
    setStatus('‚ö†Ô∏è D√©j√† enregistr√© (anti-double-clic).', 'warn');
    return;
  }
  lastSaveKey = saveKey; lastSaveAt = nowMs;
  const id = makeStableActionId(fnsku, asin, caisse, action);
  const row = {
    id,
    ts: new Date().toISOString(),
    device: deviceId,
    fnsku,
    asin,
    caisse,
    action,
    synced: false
  };
  await idbPut('actions', row);
  await renderActions();
  await refreshPills();

  setStatus('Action enregistr√©e offline.', 'ok');

  // auto sync if online
  autoSync();
}

/* ===== Camera scan (Android Chrome) ===== */
let scanStream = null;
let scanTimer = null;
let lastScanValue = '';
let scanTrack = null;
let torchOn = false;

function buzz_(){
  try{ if(navigator.vibrate) navigator.vibrate(60); }catch(e){}
}
function beep_(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880; g.gain.value = 0.05;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 80);
  }catch(e){}
}

async function setTorch_(on){
  torchOn = !!on;
  const btn = $('btnTorch');
  try{
    if(!scanTrack) throw new Error('no track');
    const caps = scanTrack.getCapabilities ? scanTrack.getCapabilities() : {};
    if(!caps || !('torch' in caps) || caps.torch !== true) throw new Error('torch not supported');
    await scanTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
    if(btn) btn.style.opacity = torchOn ? '1' : '0.7';
  }catch(e){
    // torch not supported
    if(btn) btn.style.opacity = '0.4';
  }
}

async function startScan_(){
  const overlay = $('scanOverlay');
  const video = $('scanVideo');
  const msg = $('scanMsg');
  const btnTorch = $('btnTorch');

  if(!overlay || !video || !msg){
    setStatus('Scan cam√©ra: UI manquante.', 'err');
    return;
  }

  if(!('BarcodeDetector' in window)){
    overlay.style.display = 'block';
    msg.textContent = 'BarcodeDetector non support√© (Chrome Android r√©cent requis).';
    return;
  }

  // Stop any previous session
  stopScan_();

  overlay.style.display = 'block';
  msg.textContent = 'Ouverture cam√©ra‚Ä¶';

  scanStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: 'environment' } },
    audio: false
  });

  video.srcObject = scanStream;
  await video.play();

  // Track for torch
  scanTrack = scanStream.getVideoTracks ? (scanStream.getVideoTracks()[0] || null) : null;
  torchOn = false;
  if(btnTorch){
    btnTorch.style.opacity = '0.7';
    // Enable/disable torch button depending on capabilities
    try{
      const caps = scanTrack && scanTrack.getCapabilities ? scanTrack.getCapabilities() : {};
      const supported = !!(caps && ('torch' in caps) && caps.torch === true);
      btnTorch.style.display = supported ? 'inline-block' : 'none';
    }catch(_){
      btnTorch.style.display = 'none';
    }
  }

  msg.textContent = 'Scanne le code‚Ä¶';

  const detector = new BarcodeDetector({
    formats: ['code_128','ean_13','ean_8','qr_code','data_matrix','itf']
  });

  lastScanValue = '';

  scanTimer = setInterval(async ()=>{
    try{
      const codes = await detector.detect(video);
      if(!codes || !codes.length) return;

      const raw = (codes[0].rawValue || '').trim();
      if(!raw) return;

      if(raw === lastScanValue) return;
      lastScanValue = raw;

      stopScan_();
      beep_(); buzz_();

      $('fnsku').value = raw;
      $('fnsku').dispatchEvent(new Event('input', {bubbles:true}));
      if(typeof lookupFnsku === 'function') await lookupFnsku();
    }catch(e){
      // ignore intermittent errors
    }
  }, 180);
}

function stopScan_(){
  if(scanTimer){ clearInterval(scanTimer); scanTimer = null; }
  // turn torch off before stopping
  try{ if(scanTrack) scanTrack.applyConstraints({ advanced: [{ torch: false }] }); }catch(e){}
  torchOn = false;
  scanTrack = null;

  if(scanStream){
    try{ scanStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    scanStream = null;
  }
  const overlay = $('scanOverlay');
  if(overlay) overlay.style.display = 'none';
}

/* UI bindings */
$('btnLookup').onclick = lookupFnsku;
$('btnClear').onclick = ()=>{
  $('fnsku').value='';
  $('q').value='';
  $('results').innerHTML='';
  selectedProduct=null;
  currentFnsku='';
  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');
  setStatus('Pr√™t.', '');
  $('fnsku').focus();
};

$('btnScanCam').onclick = ()=>{
  startScan_().catch(err=>{
    $('scanOverlay').style.display = 'block';
    $('scanMsg').textContent = 'Erreur cam√©ra: ' + (err.message || err);
  });
};
$('btnStopScan') && ($('btnStopScan').onclick = stopScan_);
$('btnTorch') && ($('btnTorch').onclick = ()=>{ setTorch_(!torchOn); });

$('btnSearch').onclick = doSearch;
$('accountFilter').addEventListener('change', ()=>doSearch());
$('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

$('btnLink').onclick = linkFnsku;
$('btnChange').onclick = ()=>{
  showOnly('searchBox');
  $('linkStatus').textContent='';
};

$('btnSaveKnown').onclick = async ()=>{
  const fnsku = currentFnsku;
  const mapped = await idbGet('mapping', fnsku);
  const asin = mapped ? mapped.asin : '';
  await saveAction({fnsku, asin, caisse:$('caisseKnown').value, action:$('actionKnown').value});
};

$('btnSaveAfter').onclick = async ()=>{
  await saveAction({fnsku: currentFnsku, asin: selectedProduct.asin, caisse:$('caisseAfter').value, action:$('actionAfter').value});
};

$('btnSettings').onclick = ()=>{
    // init langue
    const lm = $('langMode');
    if(lm){ lm.value = getLang(); }
  $('settingsBox').classList.toggle('hidden'); };
// Langue (FR/‰∏≠Êñá)
$('langMode') && ($('langMode').onchange = ()=>{
  setLang($('langMode').value);
  // refresh UI
  if(selectedProduct) $('confirmProd').innerHTML = prodHTML(selectedProduct);
  if($('knownProd').innerHTML) { /* re-render happens next search */ }
  if(typeof renderLastActions==='function') renderLastActions();
});

$('btnCloseSettings').onclick = ()=>{ $('settingsBox').classList.add('hidden'); };

$('btnSaveSettings').onclick = async ()=>{
  apiUrl = ($('apiUrl').value||'').trim();
  secret = ($('secret').value||'').trim();
  localStorage.setItem(LS.apiUrl, apiUrl);
  localStorage.setItem(LS.secret, secret);
  $('settingsStatus').textContent = '‚úÖ Sauv√©. Fais ‚ÄúMettre √† jour base + mapping‚Äù.';
  await refreshPills();
};

$('btnResetCache').onclick = async ()=>{
  if(!confirm('Effacer base produits + mapping + actions locales ?')) return;
  await idbDelAll('products');
  await idbDelAll('mapping');
  await idbDelAll('actions');
  localStorage.removeItem(LS.stateMap);
  localStorage.removeItem(LS.lastPull);
  $('syncMsg').textContent='';
  setStatus('Cache effac√©.', 'warn');
  await renderActions();
  await refreshPills();
};

$('btnSyncNow').onclick = autoSync;
$('btnPullNow').onclick = pullAll;
$('btnRebuildState').onclick = async ()=>{
  try{
    $('syncMsg').textContent = '‚è≥ Rebuild stock serveur (depuis actions)...';
    const r = await apiGet({op:'rebuild_state'});
    if(!r.ok) throw new Error(r.error||'rebuild_state failed');

    const p = await apiGet({op:'pull_state'});
    if(!p.ok) throw new Error(p.error||'pull_state failed');

    const arr = p.state || [];
    const sm = {};
    for(const it of arr){
      const fn = (it.fnsku||'').toUpperCase().trim();
      const ca = (it.caisse||'').toUpperCase().trim();
      if(!fn || !ca) continue;
      if(!sm[fn]) sm[fn] = { asin: (it.asin||'').toUpperCase().trim(), caisses:{} };
      if(it.asin) sm[fn].asin = (it.asin||'').toUpperCase().trim();
      sm[fn].caisses[ca] = Number(it.qty||0)||0;
    }
    saveStateMap(sm);

    try{ if(selectedProduct){ $('knownProd').innerHTML = prodHTML(selectedProduct, {fnsku: currentFnsku}); } }catch(e){}
    try{ if($('confirmCaisses')){ const b = stateBadgesForFnsku((currentFnsku||'').toUpperCase().trim()); $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (b && b!=='‚Äî' ? b.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî'); } }catch(e){}

    refreshPills();
    $('syncMsg').textContent = `‚úÖ Rebuild OK ‚Äî rebuilt=${r.rebuilt||0} ‚Äî lignes STOCK_STATE=${arr.length}`;
  }catch(e){
    $('syncMsg').textContent = '‚ùå Rebuild: '+(e.message||e);
  }
};

/* Auto sync triggers */
window.addEventListener('online', ()=>{
  refreshPills();
  $('syncMsg').textContent = 'üåê R√©seau revenu ‚Üí sync auto...';
  autoSync();
});
window.addEventListener('offline', refreshPills);

// auto sync every 45s when online (lightweight)
setInterval(()=>{ if(online()) autoSync(); }, 45000);

/* Init */
(async function init(){
  db = await openDB();
  await refreshPills();
  await renderActions();

  // Autofocus for paste flow
  $('fnsku').focus();

  // If online and configured, pull base early
  if(online() && apiUrl && secret){
    await pullAll();
  }
})();
</script>
<script>
(function () {

  function findFnskuInput() {
    // 1Ô∏è‚É£ priorit√© au placeholder FNSKU
    let el = [...document.querySelectorAll('input')]
      .find(i =>
        i.placeholder &&
        i.placeholder.toLowerCase().includes('fnsku')
      );

    if (el) return el;

    // 2Ô∏è‚É£ fallback : premier input texte visible
    el = [...document.querySelectorAll('input[type="text"]')]
      .find(i => i.offsetParent !== null);

    return el || null;
  }

  function focusAndSelect() {
    const input = findFnskuInput();
    if (!input) return;

    // petit d√©lai pour Android / PWA
    setTimeout(() => {
      input.focus();
      input.select();
    }, 80);
  }

  // üîÅ quand on revient depuis une autre app (Binary Eye)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      focusAndSelect();
    }
  });

  // üîÅ au retour arri√®re Android
  window.addEventListener('pageshow', focusAndSelect);

  // üîÅ premier chargement
  window.addEventListener('load', focusAndSelect);

})();
</script>
</body>
</html>
