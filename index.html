<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vine Stock</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111"/>
  <style>
    body{font-family:system-ui;margin:14px;max-width:880px}
    h2{margin:8px 0 6px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,select{font-size:16px;padding:10px}
    button{cursor:pointer}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;font-size:13px;color:#444}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .prod{display:flex;gap:10px;align-items:flex-start}
    .prod img{width:64px;height:64px;object-fit:cover;border-radius:10px;background:#f4f4f4}
    .prod h4{margin:0 0 4px;font-size:15px}
    .prod .meta{font-size:13px;color:#555}
    .list{max-height:420px;overflow:auto;border:1px solid #eee;border-radius:12px}
    .item{padding:10px;border-bottom:1px solid #eee}
    .item:last-child{border-bottom:none}
    .ok{color:#0a7}
    .warn{color:#b60}
    .err{color:#c00}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;font-size:13px;text-align:left}
    .twoCol{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.twoCol{grid-template-columns:1fr 1fr}}
    .btnPrimary{background:#111;color:#fff;border:none;border-radius:12px}
    .btnGhost{background:#fff;border:1px solid #ddd;border-radius:12px}
    .btnDanger{background:#fff;border:1px solid #f2c; border-radius:12px}
    .small{font-size:13px;padding:8px 10px}
    .hidden{display:none}
  </style>
</head>
<body>

<h2>üì¶ Vine Stock (FNSKU ‚Üí ASIN)</h2>
<div class="row">
  <span class="pill" id="netPill">R√©seau: ?</span>
  <span class="pill" id="cachePill">Base: ?</span>
  <span class="pill" id="mapPill">Mapping: ?</span>
</div>
<div class="muted" style="margin-top:6px">
  Scan via Binary Eye ‚Üí colle le FNSKU ici. Si inconnu, recherche + double confirmation. Sync auto quand le r√©seau revient.
</div>

<div class="card">
  <h3 style="margin:0 0 10px">1) Scanner / coller le FNSKU</h3>
  <div class="row">
    <input id="fnsku" placeholder="FNSKU (ex: X000QEDMAD)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnScan">üì∑</button>
    <button class="btnGhost" id="btnClear">Effacer</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnLookup">Chercher</button>
    <button class="btnGhost" id="btnSettings">‚öôÔ∏è R√©glages</button>
    <span class="muted" id="status">Pr√™t.</span>
  </div>
</div>

<!-- PRODUIT CONNU -->
<div class="card hidden" id="knownBox">
  <h3 style="margin:0 0 10px">Produit trouv√© (FNSKU connu)</h3>
  <div class="prod" id="knownProd"></div>
  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <input id="caisseKnown" placeholder="Caisse (ex: A3)" />
    <select id="actionKnown">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveKnown">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- FNSKU INCONNU : RECHERCHE -->
<div class="card hidden" id="searchBox">
  <h3 style="margin:0 0 10px">FNSKU inconnu ‚Üí choisir le produit</h3>

  <div class="row">
    <input id="q" placeholder="Recherche (marque / mot / ASIN B0‚Ä¶)" style="flex:1;min-width:260px" />
    <button class="btnGhost" id="btnSearch">Rechercher</button>
  </div>
  <div class="row" style="margin-top:8px">
    <label class="muted" for="accountFilter" style="min-width:120px">Filtre compte</label>
    <select id="accountFilter" style="flex:1;min-width:260px">
      <option value="">Tous les comptes</option>
    </select>
  </div>
  <div class="muted" style="margin-top:8px">
    R√©sultats depuis la base produits locale. (Si vide: fais une mise √† jour en ligne dans R√©glages.)
  </div>

  <div class="list" id="results" style="margin-top:10px"></div>
</div>

<!-- CONFIRMATION (Option B) -->
<div class="card hidden" id="confirmBox">
  <h3 style="margin:0 0 10px">2) Double confirmation</h3>

  <div class="twoCol">
    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Produit choisi</h4>
      <div class="prod" id="confirmProd"></div>
      <div class="row" style="margin-top:10px">
        <a id="confirmLink" href="#" target="_blank" class="pill">Ouvrir Amazon</a>
        <span class="pill" id="confirmAsin">ASIN: ?</span>
        <span class="pill" id="confirmPrice">Prix: ?</span>
        <span class="pill" id="confirmCaisses">üß∫ Stock global: ‚Äî</span>
      </div>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">Historique (MASTER)</h4>
      <div class="muted" id="histHint">Si offline, historique = dernier cache.</div>
      <div style="max-height:240px;overflow:auto;border:1px solid #eee;border-radius:12px">
        <table>
          <thead><tr><th>Date</th><th>Email</th></tr></thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

  <div class="row">
    <button class="btnPrimary" id="btnLink">‚úÖ Valider le lien FNSKU ‚Üí ASIN</button>
    <button class="btnGhost" id="btnChange">‚Ü©Ô∏è Changer de produit</button>
    <span class="muted" id="linkStatus"></span>
  </div>
</div>

<!-- APR√àS LIEN : RANGEMENT -->
<div class="card hidden" id="afterLinkBox">
  <h3 style="margin:0 0 10px">3) Ranger / enregistrer</h3>
  <div class="prod" id="afterProd"></div>
  <div class="row" style="margin-top:10px">
    <input id="caisseAfter" placeholder="Caisse (ex: A3)" />
    <select id="actionAfter">
      <option value="ADD">ADD (ranger)</option>
      <option value="MOVE">MOVE</option>
      <option value="REMOVE">REMOVE</option>
      <option value="SOLD">SOLD</option>
    </select>
    <button class="btnPrimary" id="btnSaveAfter">‚úÖ Enregistrer</button>
  </div>
  <div class="muted">Caisse propos√©e = derni√®re caisse utilis√©e (globale).</div>
</div>

<!-- HISTORIQUE LOCAL (actions) -->
<div class="card">
  <h3 style="margin:0 0 10px">üïì Derni√®res actions (local)</h3>
  <div class="row">
    <button class="btnGhost small" id="btnSyncNow">Sync maintenant</button>
    <button class="btnGhost small" id="btnPullNow">Mettre √† jour base + mapping</button>
    <button class="btnGhost small" id="btnRebuildState">Rebuild stock (serveur)</button>
    <span class="muted" id="syncMsg"></span>
  </div>
  <div style="max-height:260px;overflow:auto;border:1px solid #eee;border-radius:12px;margin-top:10px">
    <table>
      <thead><tr><th>Date</th><th>FNSKU</th><th>ASIN</th><th>Caisse</th><th>Action</th><th>Sync</th></tr></thead>
      <tbody id="actionsTable"></tbody>
    </table>
  </div>
</div>

<!-- SETTINGS -->
<div class="card hidden" id="settingsBox">
  <h3 style="margin:0 0 10px">‚öôÔ∏è R√©glages</h3>
  <div class="muted">Colle ici l‚ÄôURL /exec de ton Apps Script + ton SECRET.</div>
  <div class="row" style="margin-top:10px">
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;min-width:280px"/>
    <input id="secret" placeholder="SECRET" style="min-width:180px"/>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btnPrimary" id="btnSaveSettings">Enregistrer</button>
    <button class="btnGhost" id="btnCloseSettings">Fermer</button>
    <span class="muted" id="settingsStatus"></span>
  </div>

  <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
  <div class="row">
    <button class="btnGhost" id="btnResetCache">R√©initialiser cache local</button>
    <span class="muted">‚ö†Ô∏è Efface base produits, mapping et actions non sync.</span>
  </div>
</div>

<!-- OVERLAY SCAN CAMERA -->
<div id="scanModal" class="hidden">
  <video id="video" style="width:100%; height:100%; object-fit:cover;" autoplay playsinline></video>
  <button class="btnGhost" id="btnCloseScan" style="position:absolute; top:10px; right:10px;">‚ùå</button>
  <button class="btnGhost hidden" id="btnFlash" style="position:absolute; top:10px; left:10px;">üî¶</button>
</div>

<script>
/* PWA cache */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }

const $ = (id)=>document.getElementById(id);
const netPill=$('netPill'), cachePill=$('cachePill'), mapPill=$('mapPill');

const LS = {
  apiUrl: 'vine_api_url',
  secret: 'vine_secret',
  device: 'vine_device',
  lastCaisse: 'vine_last_caisse',
  lastPull: 'vine_last_pull',
  caisseMap: 'vine_caisse_by_asin',
  caisseCountMap: 'vine_caisse_counts_by_asin',
  actionsCursor: 'vine_actions_cursor',
  stateMap: 'vine_state_by_fnsku',
  fnskuMap: 'vine_fnskuMap',
  lang: 'vine_lang'
};

const deviceId = localStorage.getItem(LS.device) || (()=>{
  const v='phone_'+Math.random().toString(16).slice(2,8);
  localStorage.setItem(LS.device, v);
  return v;
})();

let apiUrl = localStorage.getItem(LS.apiUrl) || '';
let secret = localStorage.getItem(LS.secret) || '';
let lastCaisse = (localStorage.getItem(LS.lastCaisse) || '').toUpperCase();

$('apiUrl').value = apiUrl;
$('secret').value = secret;

const DB_NAME='vine_global', DB_VER=1;
let db;

/* IndexedDB stores:
   - products (key asin) => {asin,title,photo_url,product_url,price,orders_count,history}
   - mapping (key fnsku) => {fnsku,asin,linked_at,device}
   - actions (auto id) => {id,ts,device,fnsku,asin,caisse,action,synced:false}
*/
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded=()=>{
      const d=r.result;
      if(!d.objectStoreNames.contains('products')) d.createObjectStore('products', {keyPath:'asin'});
      if(!d.objectStoreNames.contains('mapping')) d.createObjectStore('mapping', {keyPath:'fnsku'});
      if(!d.objectStoreNames.contains('actions')) d.createObjectStore('actions', {keyPath:'id'});
    };
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>rej(r.error);
  });
}

function idbPut(store, val){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    tx.objectStore(store).put(val);
    tx.oncomplete=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).get(key);
    req.onsuccess=()=>res(req.result||null);
    req.onerror=()=>rej(req.error);
  });
}
function idbGetAll(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly');
    const req=tx.objectStore(store).getAll();
    req.onsuccess=()=>res(req.result||[]);
    req.onerror=()=>rej(req.error);
  });
}
function idbDelAll(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite');
    const req=tx.objectStore(store).clear();
    req.onsuccess=()=>res();
    req.onerror=()=>rej(req.error);
  });
}

async function pullAllActionsFromServer(){
  if(!online()) return 0;
  if(!apiUrl || !secret) return 0;
  let cursor = 0;
  let total = 0;
  while(true){
    const r = await apiGet(`op=pull_actions&cursor=${cursor}&limit=2000`);
    if(!r.ok) throw new Error(r.error||'pull_actions failed');
    const actions = r.actions||[];
    for(const a of actions){
      // Store in IDB; mark as synced
      await idbPut('actions', { ...a, synced:true });
    }
    total += actions.length;
    if(r.next_cursor===null || r.next_cursor===undefined) break;
    cursor = r.next_cursor;
    if(actions.length===0) break;
  }
  return total;
}

/* Auto sync: when online => push then pull */
let syncLock=false;
async function autoSync(){
  if(syncLock) return;
  if(!online()) return;
  if(!apiUrl || !secret) return;
  syncLock=true;
  try{
    await pushActions();
    // Phase 2 (recommand√©e) : on pull STOCK_ACTIONS et on reconstruit les caisses globales
    try{
      const r = await pullStockActions();
      if(r && r.pulled){
        $('syncMsg').textContent = `‚úÖ Stock actions mises √† jour (+${r.pulled})`;
      }
    }catch(e){
      // on n'emp√™che pas la suite (base + mapping)
      $('syncMsg').textContent = '‚ö†Ô∏è Stock actions: '+(e.message||e);
    }
    await pullAll();
  }finally{
    syncLock=false;
  }
}

/* Lookup flow */
let currentFnsku='', selectedProduct=null;

async function lookupFnsku(){
  const rawIn = ($('fnsku').value||'').trim();

  // ‚úÖ Bonus : tu peux coller un ASIN (ou une URL Amazon) dans le champ "FNSKU"
  // - Si un ASIN est d√©tect√©, on affiche le produit sans passer par le mapping.
  // - Si une seule ligne de mapping pointe vers cet ASIN, on remplace automatiquement
  //   le champ par le FNSKU correspondant pour permettre l'enregistrement.
  const urlAsin = rawIn.match(/\b([A-Z0-9]{10})\b/i);
  const maybeAsin = rawIn.includes('/dp/') || rawIn.includes('amazon.') ? (urlAsin ? urlAsin[1] : '') : rawIn;
  const asinCandidate = normAsin(maybeAsin);
  const isAsin = /^[A-Z0-9]{10}$/.test(asinCandidate);

  if(isAsin){
    // Essayez de retrouver un FNSKU unique depuis le mapping (pour autoriser "Enregistrer")
    try{
      const mpAll = await idbGetAll('mapping');
      const hits = mpAll.filter(x => x && normAsin(x.asin) === asinCandidate && x.fnsku);
      if(hits.length === 1){
        currentFnsku = normFnsku(hits[0].fnsku);
        $('fnsku').value = currentFnsku;
      }else{
        currentFnsku = ''; // affichage OK, mais pas d'"Enregistrer" sans FNSKU
      }
    }catch(_){ currentFnsku = ''; }

    // Affiche le produit directement depuis la base (products)
    const p = await idbGet('products', asinCandidate);
    if(!p){
      setStatus('ASIN reconnu, mais produit non trouv√© en local. Fais "Mettre √† jour base + mapping".', 'warn');
      showOnly('settingsBox');
      return;
    }
    selectedProduct = p;
    $('knownProd').innerHTML = prodHTML(p, {fnsku: currentFnsku});
    // Affiche les caisses (avec quantit√©s) juste √† c√¥t√© des infos produit
    // prodHTML() inclut deja le badge "caisses" (avec quantites)
    proposeCaisse();
    setStatus(currentFnsku ? 'ASIN reconnu ‚Üí FNSKU auto (unique).' : 'ASIN reconnu (lecture seule).', 'ok');
    showOnly('knownBox');
    return;
  }

  // Mode normal : FNSKU
  currentFnsku = normFnsku(rawIn);
  $('fnsku').value = currentFnsku;
  if(!currentFnsku){ setStatus('FNSKU vide', 'warn'); return; }

  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');

  setStatus('Recherche mapping...', '');
  const mapped = await idbGet('mapping', currentFnsku);

  if(mapped && mapped.asin){
    const asin = normAsin(mapped.asin);
    const p = await idbGet('products', asin);
    if(p){
      $('knownProd').innerHTML = prodHTML(p, {fnsku: currentFnsku});
    }else{
      $('knownProd').innerHTML = `<div class="muted warn">Produit non trouv√© dans la base locale (ASIN: ${asin}). Fais une mise √† jour en ligne.</div>`;
    }
    proposeCaisse();
    showOnly('knownBox');
    setStatus('FNSKU connu.', 'ok');
    return;
  }

  // Unknown => search
  showOnly('searchBox');
  setStatus('FNSKU inconnu ‚Üí recherche produit.', 'warn');
  $('q').value = '';
  $('results').innerHTML = '';
  $('q').focus();
}

/* Search products */
async function doSearch(){
  const qRaw = ($('q').value||'').trim();
  const q = qRaw.toUpperCase();
  const qFold = foldText(qRaw);
  const all = await idbGetAll('products');

  // Remplit le filtre compte (une seule fois) √† partir des donn√©es locales
  const selEl = $('accountFilter');
  if(selEl && selEl.options && selEl.options.length <= 1){
    const emails = collectAccountEmails(all); // tri√©s
    for(const em of emails){
      const opt = document.createElement('option');
      opt.value = em;
      opt.textContent = aliasFromEmail(em);
      selEl.appendChild(opt);
    }
  }

  const accEmail = selEl ? (selEl.value||'').trim().toLowerCase() : '';

  if(!all.length){
    $('results').innerHTML = `<div class="item"><div class="muted err">Base produits vide. Va dans ‚öôÔ∏è R√©glages, puis ‚ÄúMettre √† jour base + mapping‚Äù.</div></div>`;
    return;
  }

  const filtered = all
    .filter(p => {
      const hay = (p.brand+' '+p.title+' '+p.asin).toUpperCase();
      return (!accEmail || (p.account_email||'').toLowerCase()===accEmail)
        && (hay.includes(q) || foldText(hay).includes(qFold));
    })
    .slice(0,60);

  if(!filtered.length){
    $('results').innerHTML = `<div class="item"><div class="muted warn">Aucun r√©sultat.</div></div>`;
    return;
  }

  $('results').innerHTML = filtered.map(p=>`
    <div class="item">
      <div class="prod">${prodHTML(p)}</div>
      <div class="row" style="margin-top:8px">
        <button class="btnPrimary small" data-asin="${p.asin}">S√©lectionner</button>
        <span class="pill">cmd: ${p.orders_count||0}</span>
      </div>
    </div>
  `).join('');

  // bind select buttons
  $('results').querySelectorAll('button[data-asin]').forEach(btn=>{
    btn.onclick=async ()=>{
      const asin = btn.getAttribute('data-asin');
      selectedProduct = await idbGet('products', asin);
      await showConfirm();
    };
  });
}
async function showConfirm(){
  if(!selectedProduct) return;
  showOnly('confirmBox');
  $('confirmProd').innerHTML = prodHTML(selectedProduct);
  $('confirmLink').href = selectedProduct.product_url || '#';
  $('confirmAsin').textContent = 'ASIN: ' + selectedProduct.asin;
  $('confirmPrice').textContent = 'Prix: ' + (selectedProduct.price || '‚Äî');
  const badge = stateBadgesForFnsku((currentFnsku||'').toUpperCase().trim());
  $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (badge && badge!=='‚Äî' ? badge.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî');

  const hist = Array.isArray(selectedProduct.history) ? selectedProduct.history : [];
  $('histTable').innerHTML = hist.slice(0,80).map(h=>`
    <tr><td>${escapeHtml((h.order_date||'').toString())}</td><td>${escapeHtml((h.email||'').toString())}</td></tr>
  `).join('') || `<tr><td colspan="2" class="muted">Aucun historique en cache.</td></tr>`;

  $('linkStatus').textContent = '';
}

async function linkFnsku(){
  if(!selectedProduct) return;
  const fnsku = currentFnsku;
  const asin = selectedProduct.asin;

  if(!online()){
    $('linkStatus').textContent = '‚ùå Impossible de lier sans internet (global apr√®s synchro).';
    $('linkStatus').className = 'muted err';
    return;
  }
  if(!apiUrl || !secret){
    $('linkStatus').textContent = '‚ùå R√©glages API manquants.';
    $('linkStatus').className = 'muted err';
    return;
  }

  $('linkStatus').textContent = '‚è≥ Liaison en cours...';
  $('linkStatus').className = 'muted';

  const resp = await apiPost({op:'link_fnsku', fnsku, asin, device: deviceId, linked_at: new Date().toISOString()});
  if(resp.ok){
    // update local mapping cache
    await idbPut('mapping', {fnsku, asin, linked_at: new Date().toISOString(), device: deviceId});
    $('linkStatus').textContent = '‚úÖ Lien cr√©√©';
    $('linkStatus').className = 'muted ok';

    // proceed to action box
    $('afterProd').innerHTML = prodHTML(selectedProduct, {fnsku: currentFnsku});
    proposeCaisse();
    showOnly('afterLinkBox');
    setStatus('Lien OK ‚Üí enregistre le rangement.', 'ok');
    await refreshPills();
  }else{
    const e = resp.error || '';
    if(e.startsWith('fnsku_already_linked:')){
      const already = e.split(':')[1] || '';
      $('linkStatus').textContent = '‚ö†Ô∏è D√©j√† li√© √† ' + already;
      $('linkStatus').className = 'muted warn';
      // pull mapping to update
      await pullAll();
    }else{
      $('linkStatus').textContent = '‚ùå ' + e;
      $('linkStatus').className = 'muted err';
    }
  }
}

async function saveAction({fnsku, asin, caisse, action}){
  fnsku = normFnsku(fnsku);
  asin = normAsin(asin);
  caisse = (caisse||'').toString().trim().toUpperCase();
  action = (action||'').toString().trim().toUpperCase();

  if(!fnsku){ alert('FNSKU manquant'); return; }
  if(!asin || !/^[A-Z0-9]{10}$/.test(asin)){ alert('ASIN invalide'); return; }
  if(!caisse){ alert('Caisse obligatoire'); return; }

  // update last caisse global
  localStorage.setItem(LS.lastCaisse, caisse);
  // update caisses per ASIN (multi-caisses)
  applyQtyLocal(fnsku, asin, caisse, action);
  // refresh product detail instantly (badge in prodHTML)
  try{ if(selectedProduct){ $('knownProd').innerHTML = prodHTML(selectedProduct, {fnsku: currentFnsku}); } }catch(e){}
  // refresh product detail badge instantly
  if($('confirmCaisses')){
    const badge = stateBadgesForFnsku(fnsku);
    $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (badge && badge!=='‚Äî' ? badge.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî');
  }

  const saveKey = [fnsku, asin, caisse, action].join('|');
  const nowMs = Date.now();
  if(saveKey === lastSaveKey && (nowMs - lastSaveAt) < 1200){
    setStatus('‚ö†Ô∏è D√©j√† enregistr√© (anti-double-clic).', 'warn');
    return;
  }
  lastSaveKey = saveKey; lastSaveAt = nowMs;
  const id = makeStableActionId(fnsku, asin, caisse, action);
  const row = {
    id,
    ts: new Date().toISOString(),
    device: deviceId,
    fnsku,
    asin,
    caisse,
    action,
    synced: false
  };
  await idbPut('actions', row);
  await renderActions();
  await refreshPills();

  setStatus('Action enregistr√©e offline.', 'ok');

  // auto sync if online
  autoSync();
}

/* Camera scan (BarcodeDetector) */
let stream = null, track = null, scanning = false, scanningInterval = null, flashOn = false;

async function startScan() {
  if (scanning) return;
  if (!('BarcodeDetector' in window)) {
    alert('Scan non support√© sur ce navigateur');
    return;
  }
  scanning = true;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
  } catch(e) {
    alert('Erreur acc√®s cam√©ra: ' + e.message);
    scanning = false;
    return;
  }
  track = stream.getVideoTracks()[0];
  // Show overlay
  $('scanModal').classList.remove('hidden');
  // Show camera stream
  $('video').srcObject = stream;
  // Handle flash availability
  if (track.getCapabilities().torch) {
    $('btnFlash').classList.remove('hidden');
  } else {
    $('btnFlash').classList.add('hidden');
  }
  // Create barcode detector
  const detector = new BarcodeDetector({ formats: ['code_128', 'code_39'] });
  // Start scanning periodically
  scanningInterval = setInterval(async () => {
    try {
      const barcodes = await detector.detect($('video'));
      if (barcodes.length > 0) {
        const code = (barcodes[0].rawValue || '').trim();
        if (code) {
          // Stop scanning
          clearInterval(scanningInterval);
          stream.getTracks().forEach(t => t.stop());
          // Feedback (beep and vibration)
          if (navigator.vibrate) navigator.vibrate(200);
          try {
            (new Audio("data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRH")).play();
          } catch(e) {}
          // Insert code and close overlay
          $('fnsku').value = code.toUpperCase();
          $('scanModal').classList.add('hidden');
          scanning = false;
          // Trigger lookup if available
          if (typeof lookupFnsku === 'function') {
            lookupFnsku();
          }
        }
      }
    } catch(e) {
      console.error(e);
    }
  }, 300);
}

/* UI bindings */
$('btnLookup').onclick = lookupFnsku;
$('btnScan').onclick = startScan;
$('btnClear').onclick = ()=>{
  $('fnsku').value='';
  $('q').value='';
  $('results').innerHTML='';
  selectedProduct=null;
  currentFnsku='';
  showOnly(null);
  $('knownBox').classList.add('hidden');
  $('searchBox').classList.add('hidden');
  $('confirmBox').classList.add('hidden');
  $('afterLinkBox').classList.add('hidden');
  setStatus('Pr√™t.', '');
  $('fnsku').focus();
};
$('btnCloseScan').onclick = ()=>{
  if (scanningInterval) clearInterval(scanningInterval);
  if (stream) stream.getTracks().forEach(t => t.stop());
  $('scanModal').classList.add('hidden');
  scanning = false;
  flashOn = false;
};
$('btnFlash').onclick = ()=>{
  if (track && track.getCapabilities().torch) {
    flashOn = !flashOn;
    try {
      track.applyConstraints({ advanced: [{ torch: flashOn }] });
    } catch(e) {}
  }
};
$('btnSearch').onclick = doSearch;
$('accountFilter').addEventListener('change', ()=>doSearch());
$('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

$('btnLink').onclick = linkFnsku;
$('btnChange').onclick = ()=>{
  showOnly('searchBox');
  $('linkStatus').textContent='';
};

$('btnSaveKnown').onclick = async ()=>{
  const fnsku = currentFnsku;
  const mapped = await idbGet('mapping', fnsku);
  const asin = mapped ? mapped.asin : '';
  await saveAction({fnsku, asin, caisse:$('caisseKnown').value, action:$('actionKnown').value});
};

$('btnSaveAfter').onclick = async ()=>{
  await saveAction({fnsku: currentFnsku, asin: selectedProduct.asin, caisse:$('caisseAfter').value, action:$('actionAfter').value});
};

$('btnSettings').onclick = ()=>{
    // init langue
    const lm = $('langMode');
    if(lm){ lm.value = getLang(); }
  $('settingsBox').classList.toggle('hidden');
};
// Langue (FR/‰∏≠Êñá)
$('langMode') && ($('langMode').onchange = ()=>{
  setLang($('langMode').value);
  // refresh UI
  if(selectedProduct) $('confirmProd').innerHTML = prodHTML(selectedProduct);
  if($('knownProd').innerHTML) { /* re-render happens next search */ }
  if(typeof renderLastActions==='function') renderLastActions();
});

$('btnCloseSettings').onclick = ()=>{ $('settingsBox').classList.add('hidden'); };

$('btnSaveSettings').onclick = async ()=>{
  apiUrl = ($('apiUrl').value||'').trim();
  secret = ($('secret').value||'').trim();
  localStorage.setItem(LS.apiUrl, apiUrl);
  localStorage.setItem(LS.secret, secret);
  $('settingsStatus').textContent = '‚úÖ Sauv√©. Fais ‚ÄúMettre √† jour base + mapping‚Äù.';
  await refreshPills();
};

$('btnResetCache').onclick = async ()=>{
  if(!confirm('Effacer base produits + mapping + actions locales ?')) return;
  await idbDelAll('products');
  await idbDelAll('mapping');
  await idbDelAll('actions');
  localStorage.removeItem(LS.stateMap);
  localStorage.removeItem(LS.lastPull);
  $('syncMsg').textContent='';
  setStatus('Cache effac√©.', 'warn');
  await renderActions();
  await refreshPills();
};

$('btnSyncNow').onclick = autoSync;
$('btnPullNow').onclick = pullAll;
$('btnRebuildState').onclick = async ()=>{
  try{
    $('syncMsg').textContent = '‚è≥ Rebuild stock serveur (depuis actions)...';
    const r = await apiGet({op:'rebuild_state'});
    if(!r.ok) throw new Error(r.error||'rebuild_state failed');

    const p = await apiGet({op:'pull_state'});
    if(!p.ok) throw new Error(p.error||'pull_state failed');

    const arr = p.state || [];
    const sm = {};
    for(const it of arr){
      const fn = (it.fnsku||'').toUpperCase().trim();
      const ca = (it.caisse||'').toUpperCase().trim();
      if(!fn || !ca) continue;
      if(!sm[fn]) sm[fn] = { asin: (it.asin||'').toUpperCase().trim(), caisses:{} };
      if(it.asin) sm[fn].asin = (it.asin||'').toUpperCase().trim();
      sm[fn].caisses[ca] = Number(it.qty||0)||0;
    }
    saveStateMap(sm);

    try{ if(selectedProduct){ $('knownProd').innerHTML = prodHTML(selectedProduct, {fnsku: currentFnsku}); } }catch(e){}
    try{ if($('confirmCaisses')){ const b = stateBadgesForFnsku((currentFnsku||'').toUpperCase().trim()); $('confirmCaisses').textContent = 'üß∫ Stock global: ' + (b && b!=='‚Äî' ? b.replace(/\s{2,}/g,' ¬∑ ') : '‚Äî'); } }catch(e){}

    refreshPills();
    $('syncMsg').textContent = `‚úÖ Rebuild OK ‚Äî rebuilt=${r.rebuilt||0} ‚Äî lignes STOCK_STATE=${arr.length}`;
  }catch(e){
    $('syncMsg').textContent = '‚ùå Rebuild: '+(e.message||e);
  }
};

/* Auto sync triggers */
window.addEventListener('online', ()=>{
  refreshPills();
  $('syncMsg').textContent = 'üåê R√©seau revenu ‚Üí sync auto...';
  autoSync();
});
window.addEventListener('offline', refreshPills);

// auto sync every 45s when online (lightweight)
setInterval(()=>{ if(online()) autoSync(); }, 45000);

/* Init */
(async function init(){
  db = await openDB();
  await refreshPills();
  await renderActions();

  // Autofocus for paste flow
  $('fnsku').focus();

  // If online and configured, pull base early
  if(online() && apiUrl && secret){
    await pullAll();
  }
})();
</script>
<script>
(function () {

  function findFnskuInput() {
    // 1Ô∏è‚É£ priorit√© au placeholder FNSKU
    let el = [...document.querySelectorAll('input')]
      .find(i =>
        i.placeholder &&
        i.placeholder.toLowerCase().includes('fnsku')
      );

    if (el) return el;

    // 2Ô∏è‚É£ fallback : premier input texte visible
    el = [...document.querySelectorAll('input[type="text"]')]
      .find(i => i.offsetParent !== null);

    return el || null;
  }

  function focusAndSelect() {
    const input = findFnskuInput();
    if (!input) return;

    // petit d√©lai pour Android / PWA
    setTimeout(() => {
      input.focus();
      input.select();
    }, 80);
  }

  // üîÅ quand on revient depuis une autre app (Binary Eye)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      focusAndSelect();
    }
  });

  // üîÅ au retour arri√®re Android
  window.addEventListener('pageshow', focusAndSelect);

  // üîÅ premier chargement
  window.addEventListener('load', focusAndSelect);

})();
</script>
</body>
</html>
